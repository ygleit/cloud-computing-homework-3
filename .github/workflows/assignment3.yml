name: assignment3

on: push
jobs:
  build:
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: Checkout workflow
        uses: actions/checkout@v3
        
      - name: Set start date 
        run: echo "DATE=$(date -Iminutes)" >> log.txt
        
      - name: Add submitters names
        run: echo "Yonathan Gleit, Nir Sharon" >> log.txt
      
      - name: Setup Docker
        uses: docker/setup-buildx-action@v2
      
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          dockerfile: Dockerfile
          push: false
          tags: cloud-computing-homework-3
          
      - name: Check If Image Was Successfully bulid
        if: always()
        run: |
          if ${{ success() }}; then 
            echo "image successfully built" >> log.txt
          else
            echo "image not able to be built" >> log.txt
            exit 1
          fi
          
      - name: Upload Log File
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: log
          path: log.txt

  test:
    runs-on: ubuntu-latest
    steps: 
      - name: Download Log File
        uses: actions/download-artifact@v2
        with:
          name: log
      
      - name: Run Docker Image
        if: steps.image-check.outputs.success == 'true'
        uses: docker/cli@v2
        with:
          command: run cloud-computing-homework-3
          
      - name: Check If Image Ran Successfully
        id: Running-check
        run: |
          if [[ success() ]]; then 
            echo "Container up and running" >> log.txt
          else
            echo "Container failed to run" >> log.txt
            exit 1
          fi
      
      - name: Retrieve When Failed Log File
        if: ${{ failure() }}
        uses: actions/upload-artifact@v3
        with:
          name: log
          path: log.txt
          
          

